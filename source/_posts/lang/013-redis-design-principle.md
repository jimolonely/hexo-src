---
title: redis设计和原理
tags:
  - redis
p: lang/013-redis-design-principle
date: 2019-02-21 14:01:29
---

本文是《redis设计与实现--黄健宏》一书的读后感和笔记。

# SDS（simple dynamic string）
简单动态字符串： redis自定义的字符串结构：
```c
struct sdshdr {
  // 已经使用的长度
  int len;
  // 未使用的长度
  int free;
  char buf[];
}
```
为什么不使用C语言的字符串字面量的原因：
1. 获取字符串长度复杂度为O(1), 而不是O(N)
2. 杜绝缓冲区溢出： 增加字符串内容而忘记分配合适的长度造成覆盖等
3. 减少修改字符串的内存重分配： 主要采用了2种策略
    1. 空间预分配： 低于1MB长度时，扩展会翻倍，超过1MB时每次多分配1MB
    2. 惰性空间释放： 缩短字符串时并不内存分配，只是修改free的长度
4. 二进制安全： 可以保存除文本外，图像、视频、音频等2进制信息，因为不以`\0`来判断结尾，而是len
5. 兼容部分C语言库函数： sds依然保留`\0`结尾，所以可以重复使用部分字符串函数。


